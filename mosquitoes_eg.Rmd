---
title: "Mosquito Traps and Rainfall in YEG"
author: "Alexander Ondrus"
date: "3/5/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Loading & Manipulating Data

The two CSV files that we need for this example are the Rainfall Gauge Results and the Mosquitoes Trap Data. I also load the `tidyverse` library as well.

```{r Load libraries and data, message=FALSE, warning=FALSE}
library(tidyverse)
mosquito <- read_csv("Mosquitoes_Trap_Data__May_2011_to_Sep_2015_.csv")
rain <- read_csv("Rainfall_Gauge_Results.csv")
```

Note that the mosquito data is _weekly_ and the rainfall data is _daily_. That means that I need to aggregate the rainfall data to the same frequency as the mosquito data and then join the two data frames together. Neither date column is immediately recognized as a date, so I use the `lubridate` package to set the format.

```{r Convert to date, message=FALSE, warning=FALSE}
library(lubridate)
mosquito$TRAP_DATE <- mdy(mosquito$TRAP_DATE)
rain$DATE <- mdy(rain$DATE)
```

The `lubridate` package also has a `week()` function that returns the week of the year for a given date. I will add these columns to both the mosquito and rain data. I also rename the `YEAR` column in the rain data to `Year` to match up with the mosquito data later on.

```{r Add weeks and years}
mosquito$Year <- year(mosquito$TRAP_DATE)
mosquito$Week <- week(mosquito$TRAP_DATE)

rain$Week <- week(rain$DATE)
rain <- rename(rain, Year = YEAR)
```

To simplify things greatly, I am just going to look at the total rainfall for each week and the total number of mosquitos caught each week. This means that I only need the year, week, and total columns for each data set. Note that the data is spread over multiple rows for each set, so I will need to group and summarise the data as well. To make these commands concise, I will use the pipe operator ` %>% `

```{r Select-group-summarise data}
mosquitoes_per_week <- select(mosquito, Year, Week, TOTAL) %>% 
  group_by(Year, Week) %>% 
  summarise(Total_Mosquitoes = sum(TOTAL, na.rm = TRUE)) %>% 
  filter(!is.na(Year), !is.na(Week))

rain_per_week <- select(rain, Year, Week, AMOUNT) %>% 
  group_by(Year, Week) %>% 
  summarise(Total_Rain = sum(AMOUNT, na.rm = TRUE)) %>% 
  filter(!is.na(Year), !is.na(Week))
```

Now the two data sets are on the same frequency, I can merge them using an _inner join_. This means that I only include rows that have matching values in both data frames for the specified columns.

```{r Join the data sets}
mosquitoes_w_rain <- inner_join(mosquitoes_per_week, rain_per_week, by = c("Year", "Week"))
```

## Predictive Modelling

I want to predict the number of mosquitoes caught in the trap in a given week based on the total rainfall that week and the week of the year. R has many, many ways of doing this, but I will show just two. Before I do, let's take a look at the data:

```{r Visualize with 2d bin}

library(RColorBrewer)

custom_palette = brewer.pal(5, "Reds")[2:5]

p <- ggplot(mosquitoes_w_rain, aes(x = Week, y = Total_Rain, colour = cut_number(Total_Mosquitoes, 4))) +
  geom_point(size = 2, alpha = 0.9) +
  scale_color_manual(values = custom_palette,
                     labels = c("<77","77-218","219-728",">728")) +
  labs(title = "Mosquitoes Caught in Edmonton",
       subtitle = "Across all test traps in YEG",
       x = "Week of the Year",
       y = "Total Rainfall that Week",
       colour = "Number of\nMosquitoes Caught",
       caption = "Data: City of Edmonton Open Data")+
  theme_minimal()

plot(p)
```


### Polynomial Regression

It is difficult to see any linear relationships in the data above, so instead I will try a polynomial regression. I do this using the `polym()` command to tell R that I want to use not only the original two variables, but their powers and intersections up to a specified degree.

```{r Polynomial Regression}
mosquito_polyfit <- lm(Total_Mosquitoes ~ poly(Week, Total_Rain, degree = 3), data = mosquitoes_w_rain)
```

